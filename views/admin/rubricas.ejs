<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include('../inc/menu.ejs')  %>
    <main class="main-content">
        <%- include('../inc/headerAdmin.ejs') %>

        <div style="padding: 30px;" id="rubricas">
            <div class="view-header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>Mostrar:</span>
                    <select id="entriesPerPage" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="todos">Todos</option>
                    </select>
                    <span>rúbricas</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar rúbricas...">
                    </div>
                    <select id="professorFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;">
                        <option value="">Todos los profesores</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="window.location.href='/admin/createrubricas'">
                    <i class="fas fa-plus"></i>
                    Nueva Rúbrica
                </button>
            </div>

            <div style="margin: 15px 0; color: #666; font-size: 14px;" id="infoEntries">
                Mostrando 1 a <%= rubricas.length %> de <%= rubricas.length %> rúbricas
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Asignatura</th>
                            <th>Sección</th>
                            <th>Tipo</th>
                            <th>Porcentaje</th>
                            <th>Fecha Evaluación</th>
                            <th>Profesor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="rubricasTableBody">
                        <% if(rubricas && rubricas.length > 0) { %>
                            <% rubricas.forEach(function(rubrica) { %>
                                <tr data-professor="<%= rubrica.docente_nombre %>">
                                    <td>
                                        <div class="table-cell-main">
                                            <i class="fas fa-file-alt"></i>
                                            <%= rubrica.nombre_rubrica %>
                                        </div>
                                    </td>
                                    <td><%= rubrica.materia_nombre %></td>
                                    <td><%= rubrica.seccion_codigo %></td>
                                    <td><%= rubrica.tipo_evaluacion %></td>
                                    <td><%= rubrica.porcentaje_evaluacion %>%</td>
                                    <td><%= new Date(rubrica.fecha_evaluacion).toLocaleDateString('es-ES') %></td>
                                    <td><%= rubrica.docente_nombre %></td>
                                    <td>
                                        <span class="badge-status active">Activa</span>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="btn-icon" title="Ver" onclick="verRubrica('<%= rubrica.id %>')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn-icon" title="Editar" onclick="openModal('<%= rubrica.id %>')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn-icon" title="Duplicar">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="btn-icon" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px;">
                                    <i class="fas fa-inbox" style="font-size: 48px; color: #ccc; margin-bottom: 10px; display: block;"></i>
                                    <p style="color: #999;">No hay rúbricas disponibles. Crea tu primera rúbrica.</p>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;" id="paginacion">
                <button id="btnAnterior" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                    <i class="fa fa-chevron-left"></i>
                </button>
                <div id="numerosPagina" style="display: flex; gap: 5px;">
                    <!-- Los números de página se generarán con JavaScript -->
                </div>
                <button id="btnSiguiente" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white; cursor: pointer;">
                    <i class="fa fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>
    
    <style>
        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-overlay.active {
            display: block;
        }

        /* Modal Container */
        .modal-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
        }

        .modal-header-custom h2 {
            font-size: 24px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            color: #333;
        }

        /* Modal Body */
        .modal-body-custom {
            padding: 30px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        /* Usar los mismos estilos del formulario de crear */
        .modal-body-custom .alert {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            font-size: 14px;
            color: #1565C0;
        }

        .modal-body-custom .form-group {
            margin-bottom: 20px;
        }

        .modal-body-custom .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .modal-body-custom .form-input,
        .modal-body-custom .form-select,
        .modal-body-custom .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .modal-body-custom .form-input:focus,
        .modal-body-custom .form-select:focus,
        .modal-body-custom .form-textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .modal-body-custom .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .modal-body-custom .form-row.three-cols {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .modal-body-custom .form-help {
            display: block;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Criterios Section */
        .modal-body-custom .criterios-section {
            margin-top: 30px;
        }

        .modal-body-custom .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-body-custom .section-header h3 {
            font-size: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .modal-body-custom .criterio-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .modal-body-custom .criterio-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }

        .modal-body-custom .criterio-header .form-group {
            flex: 1;
            margin: 0;
        }

        .modal-body-custom .btn-icon {
            background: #f44336;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .modal-body-custom .btn-icon:hover {
            background: #d32f2f;
        }

        /* Niveles Section */
        .modal-body-custom .niveles-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .modal-body-custom .niveles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-body-custom .niveles-header h4 {
            font-size: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .modal-body-custom .nivel-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .modal-body-custom .nivel-header {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .modal-body-custom .nivel-header .form-input {
            margin: 0;
        }

        .modal-body-custom .small-input {
            width: 80px !important;
        }

        .modal-body-custom .btn-add {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s;
        }

        .modal-body-custom .btn-add:hover {
            background: #45a049;
        }

        /* Form Actions */
        .modal-body-custom .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .modal-body-custom .btn-primary,
        .modal-body-custom .btn-secondary {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .modal-body-custom .btn-primary {
            background: #2196F3;
            color: white;
        }

        .modal-body-custom .btn-primary:hover {
            background: #1976D2;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        .modal-body-custom .btn-secondary {
            background: #757575;
            color: white;
        }

        .modal-body-custom .btn-secondary:hover {
            background: #616161;
        }

        .modal-body-custom .alert-warning {
            background: #fff8e1;
            border-left: 4px solid #ffa726;
            color: #e65100;
        }

        @media (max-width: 768px) {
            .modal-body-custom .form-row,
            .modal-body-custom .form-row.three-cols {
                grid-template-columns: 1fr;
            }

            .modal-body-custom .nivel-header {
                grid-template-columns: 1fr;
            }

            .modal-body-custom .small-input {
                width: 100% !important;
            }
        }
    </style>

    <!-- Modal Editar -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header-custom">
                <h2>
                    <i class="fas fa-edit"></i>
                    Editar Rúbrica
                </h2>
                <button class="modal-close-btn" onclick="closeModal()" title="Cerrar">
                    &times;
                </button>
            </div>

            <div class="modal-body-custom">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Complete todos los campos requeridos. Los puntajes se distribuirán automáticamente según el porcentaje de evaluación.</span>
                </div>

                <form id="rubricaFormEdit" method="post" action="/updateRubrica">
                    <input type="hidden" id="rubricaIdEdit" name="id">
                    
                    <!-- Información General -->
                    <div class="form-group">
                        <label for="nombreRubricaEdit">Nombre de la Rúbrica *</label>
                        <input type="text" id="nombreRubricaEdit" name="nombre_rubrica" class="form-input" required
                            placeholder="Ej: EVALUACIÓN INDIVIDUAL DISTRIBUCIÓN DE FRECUENCIAS">
                    </div>

                    <!-- Nueva estructura jerárquica -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carreraEdit">Carrera *</label>
                            <select id="carreraEdit" class="form-select" required>
                                <option value="">Seleccione una carrera</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="semestreEdit">Semestre *</label>
                            <select id="semestreEdit" class="form-select" required disabled>
                                <option value="">Primero seleccione una carrera</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="materiaEdit">Materia *</label>
                            <select id="materiaEdit" name="materia_codigo" class="form-select" required disabled>
                                <option value="">Primero seleccione un semestre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="seccionEdit">Sección *</label>
                            <select id="seccionEdit" name="seccion_id" class="form-select" required disabled>
                                <option value="">Primero seleccione una materia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row three-cols">
                        <div class="form-group">
                            <label for="fechaEvaluacionEdit">Fecha de Evaluación *</label>
                            <input type="date" id="fechaEvaluacionEdit" name="fecha_evaluacion" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="porcentajeEdit">Porcentaje de Evaluación (%) *</label>
                            <input type="number" id="porcentajeEdit" name="porcentaje_evaluacion" class="form-input" required
                                min="5" max="100" step="0.01" value="10" placeholder="Mínimo 5%">
                            <small class="form-help">Mínimo: 5% | Se distribuirá automáticamente entre criterios</small>
                        </div>
                        <div class="form-group">
                            <label for="tipoEvaluacionEdit">Tipo de Evaluación *</label>
                            <select id="tipoEvaluacionEdit" name="tipo_evaluacion" class="form-select" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Individual">Individual</option>
                                <option value="Grupal">Grupal</option>
                                <option value="Oral">Oral</option>
                                <option value="Taller">Taller</option>
                                <option value="Presentacion">Presentación</option>
                                <option value="Proyecto">Proyecto</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="competenciasEdit">Competencias</label>
                        <textarea id="competenciasEdit" name="competencias" class="form-textarea" rows="3"
                            placeholder="Describa las competencias que se evaluarán..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="instruccionesEdit">Instrucciones</label>
                        <textarea id="instruccionesEdit" name="instrucciones" class="form-textarea" rows="3"
                            placeholder="Instrucciones para la evaluación..."></textarea>
                    </div>

                    <!-- Información de distribución -->
                    <div class="alert alert-warning" id="distribucionInfoEdit" style="display: none;">
                        <i class="fas fa-calculator"></i>
                        <span id="distribucionTextoEdit"></span>
                    </div>

                    <!-- Criterios de Evaluación -->
                    <div class="criterios-section">
                        <div class="section-header">
                            <h3><i class="fas fa-list-check"></i> Criterios de Evaluación</h3>
                            <button type="button" class="btn-secondary" onclick="agregarCriterioEdit()">
                                <i class="fas fa-plus"></i>
                                Agregar Criterio
                            </button>
                        </div>

                        <div id="criteriosListEdit">
                            <!-- Los criterios se agregarán dinámicamente aquí -->
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeModal()">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i>
                            Actualizar Rúbrica
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="../js/home.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/rubricas.js"></script>

    <style>
        /* Ensure SweetAlert appears on top of everything */
        .swal2-container {
            z-index: 10000 !important;
        }
        .swal2-backdrop {
            z-index: 9999 !important;
        }
    </style>
</body>
</html>