<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="../css/evaluacion.css">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include('../inc/menu.ejs') %>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <%- include('../inc/headerAdmin.ejs') %>
        
        <!-- Evaluaciones View -->
        <div class="view" id="evaluaciones">
            <div class="view-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar evaluaciones...">
                </div>
                <button class="btn-primary" onclick="openModalEvaluacion()">
                    <i class="fas fa-plus"></i>
                    Nueva Evaluación
                </button>
                <div class="filter-group">
                    <select class="form-select" id="filterDocente">
                        <option value="">Todos los docentes</option>
                        <% if(typeof evaluaciones !== 'undefined' && evaluaciones.length > 0) { %>
                            <% 
                            const docentes = [...new Set(evaluaciones.map(ev => `${ev.docente_nombre} ${ev.docente_apellido}`).filter(d => d.trim() !== ''))];
                            docentes.forEach(docente => { %>
                                <option value="<%= docente %>"><%= docente %></option>
                            <% }); %>
                        <% } %>
                    </select>
                    <select class="form-select" id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Completada">Completadas</option>
                        <option value="Pendiente">Pendientes</option>
                        <option value="En Progreso">En Progreso</option>
                    </select>
                </div>
            </div>

            <!-- Controles de paginación -->
            <div class="pagination-controls">
                <div class="entries-control">
                    <label for="entriesPerPage">Mostrar:</label>
                    <select id="entriesPerPage" class="entries-select">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="all">Todos</option>
                    </select>
                    <span>evaluaciones</span>
                </div>
                <div class="pagination-info">
                    Mostrando <span id="showingStart">1</span> a <span id="showingEnd">5</span> de <span id="totalEntries"><%= evaluaciones.length %></span> evaluaciones
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Contenido</th>
                            <th>Carrera</th>
                            <th>Materia</th>
                            <th>Docente</th>
                            <th>Rúbrica</th>
                            <th>Valor</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="evaluacionesTableBody">
                        <% evaluaciones.forEach(ev => { %>
                            <tr class="evaluacion-row" data-docente="<%= ev.docente_nombre %> <%= ev.docente_apellido %>">
                                <td><%= ev.contenido_evaluacion %></td>
                                <td><%= ev.carrera_nombre %></td>
                                <td><%= ev.materia_nombre %></td>
                                <td><%= ev.docente_nombre || 'Sin asignar' %> <%= ev.docente_apellido || '' %></td>
                                <td><%= ev.nombre_rubrica %></td>
                                <td><%= ev.valor %>%</td>
                                <td><%= ev.fecha_formateada %></td>
                                <td> <span class="estado"><%= ev.estado_formateado %></span></td>
                                <td>
                                    <div class="table-actions">
    <% if (ev.estado === 'Completada' || ev.estado === 'En Progreso') { %>
        <button class="btns detalles" onclick="openModalDetalles('<%= ev.rubrica_id %>')" title="Ver Detalles"><i class="fas fa-eye"></i></button>
        <button class="btns pdf" title="Descargar PDF" onclick="DescargarPDF('<%= ev.rubrica_id %>')"><i class="fas fa-file-pdf"></i></button>
        <button class="btns excel" title="Descargar Excel" onclick="DescargarExcel('<%= ev.rubrica_id %>')"><i class="fas fa-file-excel"></i></button>
    <% } %>
    
    <% if (ev.estado === 'Pendiente') { %>
        <!-- Botones específicos para "Pendiente" -->
        <button class="btns iniciar" title="Iniciar Evaluación"><i class="fas fa-star"></i></button>
    <% } %>
</div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Botones de paginación -->
            <div class="pagination-buttons" id="paginationButtons">
                <!-- Se generarán dinámicamente con JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal Agregar Evaluación -->
    <div class="modal-add-evaluacion" id="modalAddEvaluacion">
        <div class="modal-content-evaluacion">
            <div class="modal-header-evaluacion">
                <h2><i class="fas fa-clipboard-check"></i> Nueva Evaluación</h2>
                <button class="modal-close" onclick="closeModalEvaluacion()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="formAddEvaluacion" class="modal-body-evaluacion">
            <div class="form-group">
                        <label for="observaciones">
                            <i class="fas fa-newspaper"></i>
                            Contenido (NOMBRE DE LA EVALUACIÓN)
                        </label>
                        <textarea id="contenido" name="contenido"
                                class="form-control" rows="3"
                                placeholder="Temática de la planificación a evaluar durante el exámen."
                                required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="estrategias_eval">
                            <i class="fas fa-graduation-cap"></i>
                            Estrategias de evaluación *
                        </label>
                        <div id="estrategias_eval" class ="estrategias-grid">

                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="porcentaje_evaluacion">
                                <i class="fas fa-thermometer"></i>
                                Porcentaje de Evaluación (%) *
                            </label>
                            <input type="number" id="porcentaje_evaluacion" name="porcentaje_evaluacion" class="form-input" required
                            min="1" max="100" step="0.1" value="5" placeholder="Mínimo 5%" onkeydown="return false">
                            <small class="form-help">Mínimo: 1% (0% solo para diagnósticos)</small>
                        </div>
                        <div class="form-group">
                            <label for="cant_personas">
                                <i class ="fas fa-users"></i>
                                Cantidad de personas  *
                            </label>
                            <input type="number" id="cant_personas" name="cant_personas" class="form-input" required
                            min="1" max="30" step="1" value="1" placeholder="1 para individuales, 2 para evaluaciones en pareja, etc.">
                            <small class="form-help"> Ej: individual (1), en pareja (2), grupal (+3), etc.</small>
                        </div>
                    </div>
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-search"></i>
                        Selección de Estudiantes
                    </h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="carrera_codigo">
                                <i class="fas fa-graduation-cap"></i>
                                Carrera *
                            </label>
                            <select id="carrera_codigo" name="carrera_codigo" class="form-control" required>
                                <option value="">Seleccione una carrera</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="materia_codigo">
                                <i class="fas fa-book"></i>
                                Materia *
                            </label>
                            <select id="materia_codigo" name="materia_codigo" class="form-control" required disabled>
                                <option value="">Seleccione una materia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="seccion_id">
                                <i class="fas fa-door-open"></i>
                                Sección *
                            </label>
                            <select id="seccion_id" name="seccion_id" class="form-control" required disabled>
                                <option value="">Seleccione una sección</option>
                            </select>
                        </div>
                    </div>
                    <div class="estudiantes-preview" id="estudiantesPreview">
                        <div class="loading-estudiantes">
                            <i class="fas fa-info-circle"></i>
                            Seleccione carrera, materia y sección para cargar estudiantes
                        </div>
                    </div>
                    <br>
                    <div class="date-filter-system">
                        <div class="date-info-box">
                            <i class="fas fa-info-circle"></i>
                            <span>Período académico:</span>
                            <strong id="periodoAcademico">2024-1</strong>
                        </div>
                        <div class="date-selector-system">
                            <label for="tipo_horario">
                                <i class="fas fa-calendar-check"></i>
                                Seleccione el horario donde lo realizará:
                            </label>
                            <select id="tipo_horario" class="form-select system-date-select" onchange="cambiarTipoHorario()" disabled>
                                <option value="">-- Seleccione una opción de horario --</option>
                                <option value="Sección">Horarios de la sección</option>
                                <option value="Otro">Otros (libre)</option>
                            </select>
                            <br>
                        </div>
                        
                        <div class="date-range-info">
                            <div class="range-item">
                                <i class="fas fa-calendar-day"></i>
                                <span>Días de clase:</span>
                                <strong id="diasEvaluacion">Según la sección</strong>
                            </div>
                            <div class="range-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Rango disponible:</span>
                                <strong id="rangoFechas">Inicio del semestre - Fin del semestre</strong>
                            </div>
                        </div>
                        
                        <div class="date-selector-system">
                            <label for="fecha_evaluacion">
                                <i class="fas fa-calendar-check"></i>
                                Seleccionar fecha de evaluación:
                            </label>
                            <select id="fecha_evaluacion_select" class="form-select system-date-select" required disabled>
                                <option value="">-- Seleccione una fecha --</option>
                            </select>
                            <input type='date' id="fecha_evaluacion_date" class="form-select system-date-select" style="display: none;" required disabled>
                            </input>
                            <div class="form-row"></div>
                            <div id="horas_evaluacion" class="time-inputs-compact">
                                <label for="">Hora de inicio</label>
                                <input type="time" id="hora_eval_inicio" class="time-input" placeholder="Ej: 8:00" onchange="limitarHora(this.id)" disabled></input>
                                <label for="">Hora de cierre </label>
                                <input type="time" id="hora_eval_fin" class="time-input" placeholder="Ej: 9:45" onchange="limitarHora(this.id)" disabled></input>
                            </div>
                            <div class="date-hint-system">
                                <span id="date-eval-text">Aquí dictas qué horarios te aparecen para seleccionar cuándo se hará la evaluación</span>
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Información de la Evaluación
                    </h3>
                    <div class="form-group">
                        <label for="competencias">
                            <i class="fas fa-sticky-note"></i>
                            Competencias
                        </label>
                        <textarea id="competencias" name="competencias"
                                class="form-control" rows="3"
                                placeholder="Habilidades o conocimientos que se evaluarán del estudiante."
                                required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="instrumentos">
                            <i class="fas fa-gears"></i>
                            Instrumentos
                        </label>
                        <textarea id="instrumentos" name="instrumentos"
                                class="form-control" rows="3"
                                placeholder="Herramientas a utilizar para evaluar al estudiante."
                                required></textarea>
                    </div>
                </div>
                <h3 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Datos Adicionales
                </h3>
                    <div class="form-group">
                        <label for="observaciones">
                            <i class="fas fa-comment"></i>
                            Observaciones
                        </label>
                        <textarea id="observaciones" name="observaciones"
                                class="form-control" rows="3"
                                placeholder="Observaciones generales de la evaluación (opcional)"></textarea>
                    </div>
            </form>

            <div class="modal-footer-evaluacion">
                <button type="button" class="btn-secondary" onclick="closeModalEvaluacion()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn-primary" id="btnGuardarEvaluacion" onclick="guardarEvaluacion()" disabled>
                    <i class="fas fa-save"></i>
                    Crear Evaluación
                </button>
            </div>
        </div>
    </div>

    <div class="modal-detalles-Admin" id="detalles-admin">
        <div class="modal-content-detalles">
            <div class="modal-header-detalles">
                <h2><i class="fas fa-eye"></i> Detalles de Evaluación</h2>
                <button class="modal-close" onclick="closeModalDetalles()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body-detalles" id="modalBodyDetalles">
                <!-- Contenido se carga dinámicamente -->
                <div class="loading-detalles">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando detalles...</p>
                </div>
            </div>

            <div class="modal-footer-detalles">
                <button type="button" class="btn-secondary" onclick="closeModalDetalles()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/home.js"></script>
    <script>
    window.evaluaciones = '<%- JSON.stringify(evaluaciones) %>';    
</script>
    <script src="../js/evaluacion-Admin.js"></script>
    <script>
        // Funciones del modal de ver detalles
        function openModalDetalles(rubricId) {
            const modal = document.getElementById('detalles-admin');
            const modalBody = document.getElementById('modalBodyDetalles');
            
            // Mostrar modal
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Mostrar loading
            modalBody.innerHTML = `
                <div class="loading-detalles">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando detalles...</p>
                </div>
            `;
            
            // Hacer petición para obtener detalles
            fetch(`/api/evaluacion/detalles/${rubricId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        mostrarDetallesEvaluacion(data);
                    } else {
                        modalBody.innerHTML = `
                            <div class="error-detalles">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p>${data.message || 'Error al cargar los detalles'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    modalBody.innerHTML = `
                        <div class="error-detalles">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error al cargar los detalles de la evaluación</p>
                        </div>
                    `;
                });
        }

        function closeModalDetalles() {
            const modal = document.getElementById('detalles-admin');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function mostrarDetallesEvaluacion(data) {
            const modalBody = document.getElementById('modalBodyDetalles');
            const info = data.info;
            const estudiantes = data.estudiantes;
            const criterios = data.criterios;
            
            // Calcular estadísticas
            const totalEstudiantes = estudiantes.length;
            const completadas = estudiantes.filter(e => e.puntaje_total > 0).length;
            const pendientes = totalEstudiantes - completadas;
            const promedio = estudiantes.reduce((sum, e) => sum + (parseFloat(e.puntaje_total) || 0), 0) / (completadas || 1);
            
            let html = `
                <div class="detalles-evaluacion">
                    <!-- Información de la Rúbrica -->
                    <div class="seccion-detalles">
                        <h3><i class="fas fa-clipboard-list"></i> Información de la Rúbrica</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Rúbrica:</span>
                                <span class="value">${info.nombre_rubrica}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Carrera:</span>
                                <span class="value">${info.carrera_nombre} (${info.carrera_codigo})</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Materia:</span>
                                <span class="value">${info.materia_nombre} (${info.materia_codigo})</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Sección:</span>
                                <span class="value">${info.seccion_codigo}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Docente:</span>
                                <span class="value">${info.docente_nombre} ${info.docente_apellido}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tipo:</span>
                                <span class="value">${info.tipo_evaluacion}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Porcentaje:</span>
                                <span class="value">${info.porcentaje_evaluacion}%</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Modalidad:</span>
                                <span class="value">${info.modalidad}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estadísticas -->
                    <div class="seccion-detalles">
                        <h3><i class="fas fa-chart-bar"></i> Estadísticas</h3>
                        <div class="estadisticas-grid">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-users"></i></div>
                                <div class="stat-info">
                                    <span class="stat-label">Total Estudiantes</span>
                                    <span class="stat-value">${totalEstudiantes}</span>
                                </div>
                            </div>
                            <div class="stat-card success">
                                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="stat-info">
                                    <span class="stat-label">Completadas</span>
                                    <span class="stat-value">${completadas}</span>
                                </div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                                <div class="stat-info">
                                    <span class="stat-label">Pendientes</span>
                                    <span class="stat-value">${pendientes}</span>
                                </div>
                            </div>
                            <div class="stat-card info">
                                <div class="stat-icon"><i class="fas fa-calculator"></i></div>
                                <div class="stat-info">
                                    <span class="stat-label">Promedio</span>
                                    <span class="stat-value">${promedio.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Criterios de Evaluación -->
                    <div class="seccion-detalles">
                        <h3><i class="fas fa-list-check"></i> Criterios de Evaluación</h3>
                        <div class="criterios-list">
                            ${criterios.map((c, i) => `
                                <div class="criterio-item">
                                    <span class="criterio-numero">${i + 1}</span>
                                    <span class="criterio-descripcion">${c.descripcion}</span>
                                    <span class="criterio-puntaje">${c.puntaje_maximo}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Lista de Estudiantes -->
                    <div class="seccion-detalles">
                        <h3><i class="fas fa-user-graduate"></i> Estudiantes Evaluados</h3>
                        <div class="estudiantes-table-wrapper">
                            <table class="estudiantes-detalles-table">
                                <thead>
                                    <tr>
                                        <th>Nro</th>
                                        <th>Cédula</th>
                                        <th>Estudiante</th>
                                        <th>Puntaje</th>
                                        <th>Estado</th>
                                        <th>Fecha Evaluado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estudiantes.map((est, idx) => {
                                        const puntaje = est.puntaje_total !== null ? parseFloat(est.puntaje_total).toFixed(2) : '-';
                                        const fecha = est.fecha_evaluacion
                                        
                                        let estadoClass = 'pendiente';
                                        if (est.estado === 'Completada') estadoClass = 'completada';
                                        
                                        let puntajeClass = '';
                                        if (est.puntaje_total !== 0 && fecha != 'Sin evaluar') {
                                            if (est.puntaje_total >= 40) puntajeClass = 'excelente';
                                            else if (est.puntaje_total >= 30) puntajeClass = 'bueno';
                                            else if (est.puntaje_total >= 20) puntajeClass = 'regular';
                                            else puntajeClass = 'deficiente';
                                        }
                                        
                                        return `
                                            <tr>
                                                <td>${idx + 1}</td>
                                                <td>${est.estudiante_cedula}</td>
                                                <td>${est.estudiante_apellido} ${est.estudiante_nombre}</td>
                                                <td><span class="puntaje ${puntajeClass}">${puntaje}</span></td>
                                                <td><span class="estado-badge ${estadoClass}">${est.estado}</span></td>
                                                <td>${fecha}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            modalBody.innerHTML = html;
        }

        // Cerrar modal de detalles con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modalDetalles = document.getElementById('detalles-admin');
                if (modalDetalles && modalDetalles.classList.contains('active')) {
                    closeModalDetalles();
                }
            }
        });

        // Cerrar modal al hacer clic fuera
        document.getElementById('detalles-admin')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModalDetalles();
            }
        });

        function DescargarPDF(id){
            window.location.href = `/admin/exportar/pdf/${id}`;
        }

        function DescargarExcel(id){
            window.location.href = `/admin/exportar/excel/${id}`;
        }
    </script>
</body>
</html>