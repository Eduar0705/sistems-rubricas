<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="../css/evaluacion.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include('../inc/menu.ejs') %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <%- include('../inc/headerAdmin.ejs') %>
        
        <!-- Evaluaciones View -->
        <div class="view" id="evaluaciones">
            <div class="view-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar evaluaciones...">
                </div>
                <button class="btn-primary" onclick="openModalEvaluacion()">
                    <i class="fas fa-plus"></i>
                    Nueva Evaluación
                </button>
                <div class="filter-group">
                    <select class="form-select" id="filterDocente">
                        <option value="">Todos los docentes</option>
                        <% if(typeof evaluaciones !== 'undefined' && evaluaciones.length > 0) { %>
                            <% 
                            const docentes = [...new Set(evaluaciones.map(ev => `${ev.docente_nombre} ${ev.docente_apellido}`).filter(d => d.trim() !== ''))];
                            docentes.forEach(docente => { %>
                                <option value="<%= docente %>"><%= docente %></option>
                            <% }); %>
                        <% } %>
                    </select>
                    <select class="form-select" id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Completada">Completadas</option>
                        <option value="Pendiente">Pendientes</option>
                        <option value="En Progreso">En Progreso</option>
                    </select>
                </div>
            </div>

            <!-- Controles de paginación -->
            <div class="pagination-controls">
                <div class="entries-control">
                    <label for="entriesPerPage">Mostrar:</label>
                    <select id="entriesPerPage" class="entries-select">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="all">Todos</option>
                    </select>
                    <span>evaluaciones</span>
                </div>
                <div class="pagination-info">
                    Mostrando <span id="showingStart">1</span> a <span id="showingEnd">5</span> de <span id="totalEntries"><%= evaluaciones.length %></span> evaluaciones
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Docente</th>
                            <th>Rúbrica</th>
                            <th>Valor</th>
                            <th>Carrera</th>
                            <th>Materia</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="evaluacionesTableBody">
                        <% evaluaciones.forEach(ev => { %>
                            <tr class="evaluacion-row" data-docente="<%= ev.docente_nombre %> <%= ev.docente_apellido %>">
                                <td><%= ev.docente_nombre || 'Sin asignar' %> <%= ev.docente_apellido || '' %></td>
                                <td><%= ev.nombre_rubrica %></td>
                                <td><%= ev.valor %>%</td>
                                <td><%= ev.carrera_nombre %></td>
                                <td><%= ev.materia_nombre %></td>
                                <td><%= ev.fecha_formateada %></td>
                                <td> <span class="estado"><%= ev.estado_formateado %></span></td>
                                <td>
                                    <div class="table-actions">
                                        <button class="btns detalles" onclick="verDetalles('<%= ev.rubrica_id %>')" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                                        <button class="btns pdf" title="Descargar PDF"><i class="fas fa-file-pdf"></i></button>
                                        <button class="btns excel" title="Descargar Excel"><i class="fas fa-file-excel"></i></button>
                                        <button class="btns word" title="Descargar Word"><i class="fas fa-file-word"></i></button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Botones de paginación -->
            <div class="pagination-buttons" id="paginationButtons">
                <!-- Se generarán dinámicamente con JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal Agregar Evaluación -->
    <div class="modal-add-evaluacion" id="modalAddEvaluacion">
        <div class="modal-content-evaluacion">
            <div class="modal-header-evaluacion">
                <h2><i class="fas fa-clipboard-check"></i> Nueva Evaluación</h2>
                <button class="modal-close" onclick="closeModalEvaluacion()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="formAddEvaluacion" class="modal-body-evaluacion">
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Información de la Rúbrica
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rubrica_id">
                                <i class="fas fa-list-check"></i>
                                Rúbrica *
                            </label>
                            <select id="rubrica_id" name="rubrica_id" class="form-control" required>
                                <option value="">Seleccione una rúbrica</option>
                            </select>
                        </div>
                    </div>

                    <div id="rubricaInfo" class="rubrica-info-box" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">Carrera:</span>
                            <span class="info-value" id="rubricaCarrera">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Código carrera:</span>
                            <span class="info-value" id="rubricaCarreraCodigo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Semestre:</span>
                            <span class="info-value" id="rubricaSemestre">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Materia:</span>
                            <span class="info-value" id="rubricaMateria">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Código materia:</span>
                            <span class="info-value" id="rubricaMateriaCodigo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sección:</span>
                            <span class="info-value" id="rubricaSeccion">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lapso:</span>
                            <span class="info-value" id="rubricaLapso">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Docente:</span>
                            <span class="info-value" id="rubricaDocente">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tipo:</span>
                            <span class="info-value" id="rubricaTipo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Porcentaje:</span>
                            <span class="info-value" id="rubricaPorcentaje">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Modalidad:</span>
                            <span class="info-value" id="rubricaModalidad">-</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        Selección de Estudiantes
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="carrera_codigo">
                                <i class="fas fa-graduation-cap"></i>
                                Carrera *
                            </label>
                            <select id="carrera_codigo" name="carrera_codigo" class="form-control" required>
                                <option value="">Seleccione una carrera</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="materia_codigo">
                                <i class="fas fa-book"></i>
                                Materia *
                            </label>
                            <select id="materia_codigo" name="materia_codigo" class="form-control" required disabled>
                                <option value="">Seleccione una materia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="seccion_id">
                                <i class="fas fa-door-open"></i>
                                Sección *
                            </label>
                            <select id="seccion_id" name="seccion_id" class="form-control" required disabled>
                                <option value="">Seleccione una sección</option>
                            </select>
                        </div>
                    </div>

                    <div class="estudiantes-preview" id="estudiantesPreview">
                        <div class="loading-estudiantes">
                            <i class="fas fa-info-circle"></i>
                            Seleccione carrera, materia y sección para cargar estudiantes
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Información Adicional
                    </h3>

                    <div class="form-group">
                        <label for="observaciones">
                            <i class="fas fa-comment"></i>
                            Observaciones
                        </label>
                        <textarea id="observaciones" name="observaciones"
                                class="form-control" rows="3"
                                placeholder="Observaciones generales de la evaluación (opcional)"></textarea>
                    </div>
                </div>
            </form>

            <div class="modal-footer-evaluacion">
                <button type="button" class="btn-secondary" onclick="closeModalEvaluacion()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn-primary" id="btnGuardarEvaluacion" onclick="guardarEvaluacion()" disabled>
                    <i class="fas fa-save"></i>
                    Crear Evaluación
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles de Evaluación -->
    <div class="modal-verdetalles" id="modalVerDetalles">
        <div class="modal-content-detalles">
            <div class="modal-header-detalles">
                <h2><i class="fas fa-eye"></i> Detalles de Evaluación</h2>
                <button class="modal-close" onclick="closeModalDetalles()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body-detalles" id="modalBodyDetalles">
                <!-- Contenido se carga dinámicamente -->
                <div class="loading-detalles">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando detalles...</p>
                </div>
            </div>

            <div class="modal-footer-detalles">
                <button type="button" class="btn-secondary" onclick="closeModalDetalles()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/home.js"></script>
    <script src="../js/evaluacion-Admin.js"></script>
</body>
</html>