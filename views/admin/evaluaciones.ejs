<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="../css/evaluacion.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include('../inc/menu.ejs') %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <%- include('../inc/headerAdmin.ejs') %>
        
        <!-- Evaluaciones View -->
        <div class="view" id="evaluaciones">
            <div class="view-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar evaluaciones...">
                </div>
                <button class="btn-primary" onclick="openModalEvaluacion()">
                    <i class="fas fa-plus"></i>
                    Nueva Evaluación
                </button>
                <div class="filter-group">
                    <select class="form-select" id="filterRubrica">
                        <option value="">Todas las rúbricas</option>
                        <% if(typeof evaluaciones !== 'undefined' && evaluaciones.length > 0) { %>
                            <% 
                            const rubricas = [...new Set(evaluaciones.map(ev => ev.nombre_rubrica))];
                            rubricas.forEach(rubrica => { %>
                                <option value="<%= rubrica %>"><%= rubrica %></option>
                            <% }); %>
                        <% } %>
                    </select>
                    <select class="form-select" id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="Completada">Completadas</option>
                        <option value="Pendiente">Pendientes</option>
                    </select>
                    <!-- Botones de accion para importar evaluaciones -->
                    <button class="btns excel" onclick="exportarExcel()" title="Exportar a Excel">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btns pdf" onclick="exportarPDF()" title="Exportar a PDF">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>

            <div class="evaluaciones-grid">
                <% if(typeof evaluaciones !== 'undefined' && evaluaciones.length > 0) { %>
                    <%
                    // Agrupar evaluaciones por carrera y sección
                    const evaluacionesAgrupadas = {};
                    evaluaciones.forEach(ev => {
                        const clave = `${ev.carrera_nombre} - ${ev.seccion_codigo}`;
                        if (!evaluacionesAgrupadas[clave]) {
                            evaluacionesAgrupadas[clave] = {
                                carrera: ev.carrera_nombre,
                                seccion: ev.seccion_codigo,
                                horario: ev.seccion_horario,
                                aula: ev.seccion_aula,
                                evaluaciones: []
                            };
                        }
                        evaluacionesAgrupadas[clave].evaluaciones.push(ev);
                    });
                    %>

                    <% Object.keys(evaluacionesAgrupadas).forEach(clave => { %>
                        <% const grupo = evaluacionesAgrupadas[clave]; %>
                        <div class="seccion-group">
                            <div class="seccion-header">
                                <h3 class="seccion-title">
                                    <i class="fas fa-graduation-cap"></i>
                                    <%= grupo.carrera %> - Sección <%= grupo.seccion %>
                                </h3>
                                <div class="seccion-info">
                                    <span class="seccion-detail">
                                        <i class="fas fa-clock"></i>
                                        <%= grupo.horario %>
                                    </span>
                                    <span class="seccion-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <%= grupo.aula %>
                                    </span>
                                    <span class="seccion-count">
                                        <i class="fas fa-users"></i>
                                        <%= grupo.evaluaciones.length %> evaluación(es)
                                    </span>
                                </div>
                            </div>

                            <div class="seccion-evaluaciones">
                                <% grupo.evaluaciones.forEach(ev => { %>
                                    <div class="evaluacion-card"
                                            data-rubrica="<%= ev.nombre_rubrica %>"
                                            data-estado="<%= ev.estado %>"
                                            data-estudiante="<%= ev.estudiante_nombre %> <%= ev.estudiante_apellido %>">
                                        <div class="evaluacion-header">
                                            <div class="evaluacion-student">
                                                <div class="student-avatar"><%= ev.iniciales %></div>
                                                <div>
                                                    <div class="student-name"><%= ev.estudiante_nombre %> <%= ev.estudiante_apellido %></div>
                                                    <div class="student-id">ID: <%= ev.estudiante_cedula %></div>
                                                </div>
                                            </div>
                                            <span class="badge-status <%= ev.estado === 'Completada' ? 'completed' : 'pending' %>">
                                                <%= ev.estado %>
                                            </span>
                                        </div>
                                        <div class="evaluacion-body">
                                            <div class="evaluacion-rubrica">
                                                <i class="fas fa-file-alt"></i>
                                                <%= ev.nombre_rubrica %> - <%= ev.materia_nombre %>
                                            </div>
                                            <div class="evaluacion-score">
                                                <div class="score-label">Calificación</div>
                                                <div class="score-value"><%= ev.calificacion %></div>
                                            </div>
                                        </div>
                                        <div class="evaluacion-footer">
                                            <span class="evaluacion-date">
                                                <i class="fas fa-calendar"></i>
                                                <%= ev.fecha_formateada %>
                                            </span>
                                            <% if(ev.estado === 'Completada') { %>
                                                <button class="btn-text" onclick="verDetalles('<%= ev.id %>')">Ver Detalles</button>
                                            <% } %>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No hay evaluaciones registradas</h3>
                        <p>Aún no se han realizado evaluaciones a estudiantes</p>
                    </div>
                <% } %>
            </div>
        </div>
    </main>

    <!-- Modal Agregar Evaluación -->
    <div class="modal-add-evaluacion" id="modalAddEvaluacion">
        <div class="modal-content-evaluacion">
            <div class="modal-header-evaluacion">
                <h2><i class="fas fa-clipboard-check"></i> Nueva Evaluación</h2>
                <button class="modal-close" onclick="closeModalEvaluacion()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="formAddEvaluacion" class="modal-body-evaluacion">
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-file-alt"></i>
                        Información de la Rúbrica
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="rubrica_id">
                                <i class="fas fa-list-check"></i>
                                Rúbrica *
                            </label>
                            <select id="rubrica_id" name="rubrica_id" class="form-control" required>
                                <option value="">Seleccione una rúbrica</option>
                            </select>
                        </div>
                    </div>

                    <div id="rubricaInfo" class="rubrica-info-box" style="display: none;">
                        <div class="info-row">
                            <span class="info-label">Carrera:</span>
                            <span class="info-value" id="rubricaCarrera">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Código carrera:</span>
                            <span class="info-value" id="rubricaCarreraCodigo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Semestre:</span>
                            <span class="info-value" id="rubricaSemestre">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Materia:</span>
                            <span class="info-value" id="rubricaMateria">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Código materia:</span>
                            <span class="info-value" id="rubricaMateriaCodigo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sección:</span>
                            <span class="info-value" id="rubricaSeccion">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Lapso:</span>
                            <span class="info-value" id="rubricaLapso">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Docente:</span>
                            <span class="info-value" id="rubricaDocente">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tipo:</span>
                            <span class="info-value" id="rubricaTipo">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Porcentaje:</span>
                            <span class="info-value" id="rubricaPorcentaje">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Modalidad:</span>
                            <span class="info-value" id="rubricaModalidad">-</span>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        Selección de Estudiantes
                    </h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="carrera_codigo">
                                <i class="fas fa-graduation-cap"></i>
                                Carrera *
                            </label>
                            <select id="carrera_codigo" name="carrera_codigo" class="form-control" required>
                                <option value="">Seleccione una carrera</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="materia_codigo">
                                <i class="fas fa-book"></i>
                                Materia *
                            </label>
                            <select id="materia_codigo" name="materia_codigo" class="form-control" required disabled>
                                <option value="">Seleccione una materia</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="seccion_id">
                                <i class="fas fa-door-open"></i>
                                Sección *
                            </label>
                            <select id="seccion_id" name="seccion_id" class="form-control" required disabled>
                                <option value="">Seleccione una sección</option>
                            </select>
                        </div>
                    </div>

                    <div class="estudiantes-preview" id="estudiantesPreview">
                        <div class="loading-estudiantes">
                            <i class="fas fa-info-circle"></i>
                            Seleccione carrera, materia y sección para cargar estudiantes
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Información Adicional
                    </h3>

                    <div class="form-group">
                        <label for="observaciones">
                            <i class="fas fa-comment"></i>
                            Observaciones
                        </label>
                        <textarea id="observaciones" name="observaciones"
                                class="form-control" rows="3"
                                placeholder="Observaciones generales de la evaluación (opcional)"></textarea>
                    </div>
                </div>
            </form>

            <div class="modal-footer-evaluacion">
                <button type="button" class="btn-secondary" onclick="closeModalEvaluacion()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button type="button" class="btn-primary" id="btnGuardarEvaluacion" onclick="guardarEvaluacion()" disabled>
                    <i class="fas fa-save"></i>
                    Crear Evaluación
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles de Evaluación -->
    <div class="modal-verdetalles" id="modalVerDetalles">
        <div class="modal-content-detalles">
            <div class="modal-header-detalles">
                <h2><i class="fas fa-eye"></i> Detalles de Evaluación</h2>
                <button class="modal-close" onclick="closeModalDetalles()" aria-label="Cerrar modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body-detalles" id="modalBodyDetalles">
                <!-- Contenido se carga dinámicamente -->
                <div class="loading-detalles">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando detalles...</p>
                </div>
            </div>

            <div class="modal-footer-detalles">
                <button type="button" class="btn-secondary" onclick="closeModalDetalles()">
                    <i class="fas fa-times"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/home.js"></script>
    <script src="../js/evaluacion-Admin.js"></script>
</body>
</html>