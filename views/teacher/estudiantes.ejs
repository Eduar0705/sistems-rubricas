<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="../css/estudiantes.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include("../inc/menuTeacher.ejs") %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title" id="pageTitle">Gestión de Estudiantes</h1>
            </div>
            <div class="header-right">
                <button class="header-btn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>
        
        <!-- Estudiantes View -->
        <div class="view" id="estudiantes">
            <div class="view-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar estudiantes...">
                </div>
                <div class="filter-group">
                    <select name="carrera" id="carrera" class="form-select">
                        <option value="">Todas las Carreras</option>
                        <%
                        const carrerasUnicas = [];
                        if (estudiantes && estudiantes.length > 0) {
                            estudiantes.forEach(function(estudiante) {
                                if (estudiante.carrera_codigo && !carrerasUnicas.includes(estudiante.carrera_codigo)) {
                                    carrerasUnicas.push(estudiante.carrera_codigo);
                        %>
                            <option value="<%= estudiante.carrera_codigo %>">
                                <%= estudiante.carrera_nombre || estudiante.carrera_codigo %>
                            </option>
                        <%
                                }
                            });
                        }
                        %>
                    </select>
                    <select name="seccion" id="seccion" class="form-select">
                        <option value="">Todas las Secciones</option>
                        <%
                        const seccionesUnicas = [];
                        if (estudiantes && estudiantes.length > 0) {
                            estudiantes.forEach(function(estudiante) {
                                if (estudiante.seccion) {
                                    // Split by comma and trim each section
                                    const secciones = estudiante.seccion.split(',').map(s => s.trim());
                                    secciones.forEach(function(seccion) {
                                        if (seccion && !seccionesUnicas.includes(seccion)) {
                                            seccionesUnicas.push(seccion);
                                        }
                                    });
                                }
                            });
                            // Sort sections alphabetically
                            seccionesUnicas.sort();
                            seccionesUnicas.forEach(function(seccion) {
                        %>
                            <option value="<%= seccion %>">
                                <%= seccion %>
                            </option>
                        <%
                            });
                        }
                        %>
                    </select>
                </div>
            </div>

            <!-- Controles de paginación -->
            <div class="pagination-controls">
                <div class="entries-control">
                    <label for="entriesPerPage">Mostrar:</label>
                    <select id="entriesPerPage" class="entries-select">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">Todos</option>
                    </select>
                    <span>estudiantes</span>
                </div>
                <div class="pagination-info">
                    Mostrando <span id="showingStart">1</span> a <span id="showingEnd"><%= estudiantes ? estudiantes.length : 0 %></span> de <span id="totalEntries"><%= estudiantes ? estudiantes.length : 0 %></span> estudiantes
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Cédula</th>
                            <th>Carrera</th>
                            <th>Sección</th>
                            <th>Correo</th>
                            <th>Evaluaciones</th>
                            <th>Promedio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (estudiantes && estudiantes.length > 0) { %>
                            <% estudiantes.forEach(function(estudiante) { %>
                                <tr>
                                    <td class="student-name">
                                        <span><%= estudiante.nombre %> <%= estudiante.apellido %></span>
                                    </td>
                                    <td><%= estudiante.cedula %></td>
                                    <td data-codigo="<%= estudiante.carrera_codigo %>">
                                        <span class="badge-carrera">
                                            <%= estudiante.carrera_nombre || 'Sin carrera' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge-seccion">
                                            <%= estudiante.seccion || 'Sin sección' %>
                                        </span>
                                    </td>
                                    <td>
                                        <a href="mailto:<%= estudiante.email %>" class="email-link">
                                            <%= estudiante.email %>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge-evaluaciones">
                                            <%= estudiante.total_evaluaciones || 0 %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="promedio <%= estudiante.promedio_puntaje >= 70 ? 'alto' : (estudiante.promedio_puntaje >= 50 ? 'medio' : 'bajo') %>">
                                            <%= estudiante.promedio_puntaje ? parseFloat(estudiante.promedio_puntaje).toFixed(2) : '0.00' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="btns btn-view" onclick="verEstudiante('<%= estudiante.cedula %>')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btns btn-evaluate" onclick="evaluarEstudiante('<%= estudiante.cedula %>')">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="no-data">
                                    <i class="fas fa-users"></i>
                                    No se encontraron estudiantes
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Botones de paginación -->
            <div class="pagination-buttons" id="paginationButtons">
                <!-- Se generarán dinámicamente con JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal Ver Estudiante -->
    <div id="modalVerEstudiante" class="modal-overlay">
        <div class="modal-estudiante">
            <div class="estudiante-header">
                <div class="estudiante-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="estudiante-info-header">
                    <h2 id="estudianteNombre"></h2>
                    <p><i class="fas fa-graduation-cap"></i> <span id="estudianteCarrera"></span></p>
                </div>
            </div>

            <div class="estudiante-estado">
                <span>Estado del Estudiante</span>
                <span class="badge-estado" id="estudianteEstado"></span>
            </div>

            <div class="estudiante-section">
                <h3><i class="fas fa-info-circle"></i> Información Personal</h3>
                
                <div class="info-item">
                    <div class="info-icon cedula-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">CÉDULA DE IDENTIDAD</span>
                        <span class="info-value" id="estudianteCedula"></span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon email-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">CORREO ELECTRÓNICO</span>
                        <a class="info-value info-link" id="estudianteEmail"></a>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon phone-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">TELÉFONO</span>
                        <span class="info-value" id="estudianteTelefono"></span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon calendar-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">FECHA DE NACIMIENTO</span>
                        <span class="info-value" id="estudianteNacimiento"></span>
                    </div>
                </div>
            </div>

            <div class="estudiante-section">
                <h3><i class="fas fa-chart-bar"></i> Estadísticas Académicas</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Evaluaciones</span>
                        <span class="stat-value" id="estudianteTotalEvaluaciones">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Promedio General</span>
                        <span class="stat-value" id="estudiantePromedio">0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Última Evaluación</span>
                        <span class="stat-value" id="estudianteUltimaEvaluacion">N/A</span>
                    </div>
                </div>
            </div>

            <button class="btn-cerrar" onclick="cerrarModal()">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>

    <script src="../js/home.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    // Función para buscar estudiantes
    document.getElementById('searchInput').addEventListener('input', function(e) {
        currentPage = 1; // Reset to first page when searching
        updateTable();
    });

    // Variables para paginación
    let currentPage = 1;
    let entriesPerPage = 10;
    let allRows = [];
    let filteredRows = [];

    // Inicializar paginación
    function initializePagination() {
        allRows = Array.from(document.querySelectorAll('.data-table tbody tr:not(.no-data)'));
        filteredRows = [...allRows];
        updateTable();
    }

    // Actualizar tabla según filtros y paginación
    function updateTable() {
        // Aplicar filtros primero
        applyFilters();

        // Luego aplicar paginación
        const totalRows = filteredRows.length;
        const start = (currentPage - 1) * entriesPerPage;
        const end = entriesPerPage === 'all' ? totalRows : Math.min(start + entriesPerPage, totalRows);

        // Ocultar todas las filas
        allRows.forEach(row => row.style.display = 'none');

        // Mostrar solo las filas filtradas y paginadas
        for (let i = start; i < end; i++) {
            if (filteredRows[i]) {
                filteredRows[i].style.display = '';
            }
        }

        // Actualizar información de paginación
        updatePaginationInfo(start + 1, end, totalRows);

        // Generar botones de paginación
        generatePaginationButtons(totalRows);
    }

    // Aplicar filtros
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const carreraSelect = document.getElementById('carrera');
        const carreraFilter = carreraSelect.value;
        const carreraText = carreraSelect.options[carreraSelect.selectedIndex].text.toLowerCase().trim();
        const seccionFilter = document.getElementById('seccion').value.toLowerCase().trim();

        filteredRows = allRows.filter(row => {
            const text = row.textContent.toLowerCase();
            const carreraCell = row.cells[2] ? row.cells[2].textContent.toLowerCase().trim() : '';
            const seccionCell = row.cells[3] ? row.cells[3].textContent.toLowerCase().trim() : '';

            // Filtro de búsqueda
            const matchesSearch = text.includes(searchTerm);

            // Filtro de carrera (comparar con el texto mostrado, no el valor)
            const matchesCarrera = carreraFilter === '' || carreraCell.includes(carreraText);

            // Filtro de sección
            const matchesSeccion = seccionFilter === '' || seccionCell.includes(seccionFilter);

            return matchesSearch && matchesCarrera && matchesSeccion;
        });
    }

    // Función para filtrar por cantidad (entries per page)
    document.getElementById('entriesPerPage').addEventListener('change', function(e) {
        entriesPerPage = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
        currentPage = 1;
        updateTable();
    });

    // Función para actualizar la información de paginación
    function updatePaginationInfo(start, end, total) {
        const showingStart = document.getElementById('showingStart');
        const showingEnd = document.getElementById('showingEnd');
        const totalEntries = document.getElementById('totalEntries');

        showingStart.textContent = total > 0 ? start : 0;
        showingEnd.textContent = end;
        totalEntries.textContent = total;
    }

    // Generar botones de paginación
    function generatePaginationButtons(totalRows) {
        const paginationContainer = document.getElementById('paginationButtons');
        paginationContainer.innerHTML = '';

        if (entriesPerPage === 'all' || totalRows <= entriesPerPage) return;

        const totalPages = Math.ceil(totalRows / entriesPerPage);

        // Botón anterior
        const prevBtn = document.createElement('button');
        prevBtn.className = 'pagination-btn';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        };
        paginationContainer.appendChild(prevBtn);

        // Botones de páginas
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        // Primera página si es necesario
        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.className = 'pagination-btn';
            firstBtn.textContent = '1';
            firstBtn.onclick = () => {
                currentPage = 1;
                updateTable();
            };
            paginationContainer.appendChild(firstBtn);

            if (startPage > 2) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '0 8px';
                paginationContainer.appendChild(dots);
            }
        }

        // Páginas del rango
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
            pageBtn.textContent = i;
            pageBtn.onclick = () => {
                currentPage = i;
                updateTable();
            };
            paginationContainer.appendChild(pageBtn);
        }

        // Última página si es necesario
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('span');
                dots.textContent = '...';
                dots.style.padding = '0 8px';
                paginationContainer.appendChild(dots);
            }

            const lastBtn = document.createElement('button');
            lastBtn.className = 'pagination-btn';
            lastBtn.textContent = totalPages;
            lastBtn.onclick = () => {
                currentPage = totalPages;
                updateTable();
            };
            paginationContainer.appendChild(lastBtn);
        }

        // Botón siguiente
        const nextBtn = document.createElement('button');
        nextBtn.className = 'pagination-btn';
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        };
        paginationContainer.appendChild(nextBtn);
    }

    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        initializePagination();
    });

    // Función para filtrar por carrera
    document.getElementById('carrera').addEventListener('change', function(e) {
        currentPage = 1; // Reset to first page when filtering
        updateTable();
    });

    // Función para filtrar por sección
    document.getElementById('seccion').addEventListener('change', function(e) {
        currentPage = 1; // Reset to first page when filtering
        updateTable();
    });

    // Función para ver estudiante
    function verEstudiante(cedula) {
        fetch(`/teacher/students/${cedula}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar estudiante');
                }
                return response.json();
            })
            .then(data => {
                // Llenar la información del modal
                document.getElementById('estudianteNombre').textContent = 
                    `${data.nombre} ${data.apellido}`;
                document.getElementById('estudianteCarrera').textContent = 
                    data.carrera_nombre || 'Sin carrera asignada';
                document.getElementById('estudianteCedula').textContent = data.cedula;
                document.getElementById('estudianteEmail').textContent = data.email;
                document.getElementById('estudianteEmail').href = `mailto:${data.email}`;
                document.getElementById('estudianteTelefono').textContent = 
                    data.telefono || 'No registrado';
                document.getElementById('estudianteNacimiento').textContent = 
                    data.fecha_nacimiento ? new Date(data.fecha_nacimiento).toLocaleDateString() : 'No registrada';
                
                // Estado del estudiante
                const estadoBadge = document.getElementById('estudianteEstado');
                const estado = data.estudiante_activo ? 'ACTIVO' : 'INACTIVO';
                estadoBadge.textContent = estado;
                estadoBadge.className = `badge-estado ${estado.toLowerCase()}`;
                
                // Estadísticas académicas
                document.getElementById('estudianteTotalEvaluaciones').textContent = 
                    data.total_evaluaciones || 0;
                document.getElementById('estudiantePromedio').textContent = 
                    data.promedio_puntaje ? parseFloat(data.promedio_puntaje).toFixed(2) : '0.00';
                document.getElementById('estudianteUltimaEvaluacion').textContent = 
                    data.ultima_evaluacion ? new Date(data.ultima_evaluacion).toLocaleDateString() : 'N/A';
                
                // Mostrar modal
                document.getElementById('modalVerEstudiante').classList.add('active');
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudo cargar la información del estudiante', 'error');
            });
    }

    // Funciones placeholder para otras acciones
    function editarEstudiante(cedula) {
        Swal.fire('Función en desarrollo', `Editar estudiante: ${cedula}`, 'info');
    }

    function evaluarEstudiante(cedula) {
        Swal.fire('Función en desarrollo', `Evaluar estudiante: ${cedula}`, 'info');
    }

    // Función para cerrar el modal
    function cerrarModal() {
        document.getElementById('modalVerEstudiante').classList.remove('active');
    }

    // Cerrar modal al hacer clic fuera
    document.getElementById('modalVerEstudiante')?.addEventListener('click', function(e) {
        if (e.target === this) {
            cerrarModal();
        }
    });

    // Cerrar modal con tecla ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cerrarModal();
        }
    });
    </script>
</body>
</html>