<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title || 'Rubricas' %></title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="stylesheet" href="../css/estudiantes.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include("../inc/menuTeacher.ejs") %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <%- include('../inc/headerTeacher.ejs') %>
        
        <!-- Estudiantes View -->
        <div class="view" id="estudiantes">
            <div class="view-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Buscar estudiantes...">
                </div>
                <div class="filter-group">
                    <select name="carrera" id="carrera" class="form-select">
                        <option value="">Todas las Carreras</option>
                        <%
                        const carrerasUnicas = [];
                        if (estudiantes && estudiantes.length > 0) {
                            estudiantes.forEach(function(estudiante) {
                                if (estudiante.carrera_codigo && !carrerasUnicas.includes(estudiante.carrera_codigo)) {
                                    carrerasUnicas.push(estudiante.carrera_codigo);
                        %>
                            <option value="<%= estudiante.carrera_codigo %>">
                                <%= estudiante.carrera_nombre || estudiante.carrera_codigo %>
                            </option>
                        <%
                                }
                            });
                        }
                        %>
                    </select>
                    <select name="seccion" id="seccion" class="form-select">
                        <option value="">Todas las Secciones</option>
                        <%
                        const seccionesUnicas = [];
                        if (estudiantes && estudiantes.length > 0) {
                            estudiantes.forEach(function(estudiante) {
                                if (estudiante.seccion) {
                                    // Split by comma and trim each section
                                    const secciones = estudiante.seccion.split(',').map(s => s.trim());
                                    secciones.forEach(function(seccion) {
                                        if (seccion && !seccionesUnicas.includes(seccion)) {
                                            seccionesUnicas.push(seccion);
                                        }
                                    });
                                }
                            });
                            // Sort sections alphabetically
                            seccionesUnicas.sort();
                            seccionesUnicas.forEach(function(seccion) {
                        %>
                            <option value="<%= seccion %>">
                                <%= seccion %>
                            </option>
                        <%
                            });
                        }
                        %>
                    </select>
                </div>
            </div>

            <!-- Controles de paginación -->
            <div class="pagination-controls">
                <div class="entries-control">
                    <label for="entriesPerPage">Mostrar:</label>
                    <select id="entriesPerPage" class="entries-select">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">Todos</option>
                    </select>
                    <span>estudiantes</span>
                </div>
                <div class="pagination-info">
                    Mostrando <span id="showingStart">1</span> a <span id="showingEnd"><%= estudiantes ? estudiantes.length : 0 %></span> de <span id="totalEntries"><%= estudiantes ? estudiantes.length : 0 %></span> estudiantes
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Cédula</th>
                            <th>Carrera</th>
                            <th>Sección</th>
                            <th>Correo</th>
                            <th>Evaluaciones</th>
                            <th>Promedio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (estudiantes && estudiantes.length > 0) { %>
                            <% estudiantes.forEach(function(estudiante) { %>
                                <tr>
                                    <td class="student-name">
                                        <span><%= estudiante.nombre %> <%= estudiante.apellido %></span>
                                    </td>
                                    <td><%= estudiante.cedula %></td>
                                    <td data-codigo="<%= estudiante.carrera_codigo %>">
                                        <span class="badge-carrera">
                                            <%= estudiante.carrera_nombre || 'Sin carrera' %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge-seccion">
                                            <%= estudiante.seccion || 'Sin sección' %>
                                        </span>
                                    </td>
                                    <td>
                                        <a href="mailto:<%= estudiante.email %>" class="email-link">
                                            <%= estudiante.email %>
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge-evaluaciones">
                                            <%= estudiante.total_evaluaciones || 0 %>
                                        </span>
                                    </td>
                                    <td>
                                        <span class="promedio <%= estudiante.promedio_puntaje >= 70 ? 'alto' : (estudiante.promedio_puntaje >= 50 ? 'medio' : 'bajo') %>">
                                            <%= estudiante.promedio_puntaje ? parseFloat(estudiante.promedio_puntaje).toFixed(2) : '0.00' %>
                                        </span>
                                    </td>
                                    <td>
                                        <div class="table-actions">
                                            <button class="btns btn-view" onclick="verEstudiante('<%= estudiante.cedula %>')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btns btn-evaluate" onclick="window.location.href='/teacher/evaluacion'">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="no-data">
                                    <i class="fas fa-users"></i>
                                    No se encontraron estudiantes
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Botones de paginación -->
            <div class="pagination-buttons" id="paginationButtons">
                <!-- Se generarán dinámicamente con JavaScript -->
            </div>
        </div>
    </main>

    <!-- Modal Ver Estudiante -->
    <div id="modalVerEstudiante" class="modal-overlay">
        <div class="modal-estudiante">
            <div class="estudiante-header">
                <div class="estudiante-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="estudiante-info-header">
                    <h2 id="estudianteNombre"></h2>
                    <p><i class="fas fa-graduation-cap"></i> <span id="estudianteCarrera"></span></p>
                </div>
            </div>

            <div class="estudiante-estado">
                <span>Estado del Estudiante</span>
                <span class="badge-estado" id="estudianteEstado"></span>
            </div>

            <div class="estudiante-section">
                <h3><i class="fas fa-info-circle"></i> Información Personal</h3>
                
                <div class="info-item">
                    <div class="info-icon cedula-icon">
                        <i class="fas fa-id-card"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">CÉDULA DE IDENTIDAD</span>
                        <span class="info-value" id="estudianteCedula"></span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon email-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">CORREO ELECTRÓNICO</span>
                        <a class="info-value info-link" id="estudianteEmail"></a>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon phone-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">TELÉFONO</span>
                        <span class="info-value" id="estudianteTelefono"></span>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-icon calendar-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <div class="info-content">
                        <span class="info-label">FECHA DE NACIMIENTO</span>
                        <span class="info-value" id="estudianteNacimiento"></span>
                    </div>
                </div>
            </div>

            <div class="estudiante-section">
                <h3><i class="fas fa-chart-bar"></i> Estadísticas Académicas</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Total Evaluaciones</span>
                        <span class="stat-value" id="estudianteTotalEvaluaciones">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Promedio General</span>
                        <span class="stat-value" id="estudiantePromedio">0.00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Última Evaluación</span>
                        <span class="stat-value" id="estudianteUltimaEvaluacion">N/A</span>
                    </div>
                </div>
            </div>

            <button class="btn-cerrar" onclick="cerrarModal()">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../js/home.js"></script>
    <script src="../js/estudiantes.js"></script>
</body>
</html>