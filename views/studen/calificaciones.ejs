<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Rúbricas - Estudiante</title>
    <link rel="stylesheet" href="../css/home.css">
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <%- include("../inc/menuStudents.ejs") %>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <%- include('../inc/headerStudents.ejs') %>

        <!-- Calificaciones View -->
        <div class="view active" id="calificaciones">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><%= stats.promedioGeneral %></div>
                        <div class="stat-label">Promedio General</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><%= stats.materiasAprobadas %>/<%= stats.totalMaterias %></div>
                        <div class="stat-label">Materias Aprobadas</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value"><%= stats.porcentajeCompletado %>%</div>
                        <div class="stat-label">Completado</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Calificaciones por Materia</h2>
                </div>
                <div class="card-content">
                    <% if (materias.length === 0) { %>
                        <p class="no-data">No tienes materias inscritas o calificaciones registradas.</p>
                    <% } else { %>
                        <% materias.forEach(materia => { %>
                            <div class="grade-item" onclick="verDetallesMateria('<%= JSON.stringify(materia) %>')">
                                <div class="grade-info">
                                    <h4><%= materia.nombre %> <small>(<%= materia.codigo %>)</small></h4>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: <%= materia.porcentaje_acumulado %>%"></div>
                                    </div>
                                    <small><%= materia.porcentaje_acumulado %>% Evaluado</small>
                                </div>
                                <div class="grade-score <%= materia.calificacion_final_20 >= 10 ? 'excellent' : (materia.calificacion_final_20 >= 6 ? 'good' : 'average') %>">
                                    <%= materia.promedioDisplay %>
                                </div>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Ver Evaluacion -->
    <div id="evaluacionModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-clipboard-check"></i> Detalle de Evaluación</h2>
                <button class="modal-close" onclick="cerrarModal('evaluacionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="evaluacion-summary">
                    <h3>Proyecto Final - Desarrollo Web</h3>
                    <div class="evaluacion-meta">
                        <span><i class="fas fa-calendar"></i> Evaluado: 15 Ene 2025</span>
                        <span><i class="fas fa-user"></i> Profesor: Dr. Carlos Martínez</span>
                    </div>
                    <div class="evaluacion-score-large">
                        <span class="score-label">Calificación Final</span>
                        <span class="score-value">9.2</span>
                        <span class="score-max">/ 10.0</span>
                    </div>
                </div>

                <div class="evaluacion-criterios">
                    <h4><i class="fas fa-star"></i> Evaluación por Criterios</h4>
                    <div class="criterio-evaluado">
                        <div class="criterio-eval-header">
                            <h5>Funcionalidad</h5>
                            <span class="criterio-score">24/25</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 96%"></div>
                        </div>
                        <p class="criterio-feedback"><strong>Retroalimentación:</strong> Excelente implementación de todas las funcionalidades. El sistema funciona de manera fluida y sin errores.</p>
                    </div>

                    <div class="criterio-evaluado">
                        <div class="criterio-eval-header">
                            <h5>Diseño y UX</h5>
                            <span class="criterio-score">18/20</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 90%"></div>
                        </div>
                        <p class="criterio-feedback"><strong>Retroalimentación:</strong> Diseño atractivo y profesional. La experiencia de usuario es muy buena. Sugerencia: mejorar el contraste en algunos elementos.</p>
                    </div>

                    <div class="criterio-evaluado">
                        <div class="criterio-eval-header">
                            <h5>Código</h5>
                            <span class="criterio-score">23/25</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 92%"></div>
                        </div>
                        <p class="criterio-feedback"><strong>Retroalimentación:</strong> Código muy bien estructurado y documentado. Buenas prácticas aplicadas consistentemente.</p>
                    </div>
                </div>

                <div class="comentarios-generales">
                    <h4><i class="fas fa-comment"></i> Comentarios Generales</h4>
                    <p>Excelente trabajo en general. El proyecto demuestra un dominio sólido de los conceptos vistos en clase. La implementación es profesional y cumple con todos los requisitos. Sigue así!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal('evaluacionModal')">Cerrar</button>
                <button class="btn-primary" onclick="descargarEvaluacion()">
                    <i class="fas fa-download"></i> Descargar Reporte
                </button>
            </div>
        </div>
    </div>

    <script src="./js/home.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function verDetallesMateria(materiaJson) {
            const materia = JSON.parse(materiaJson);
            const modal = document.getElementById('evaluacionModal');
            
            // Update modal content
            const modalBody = modal.querySelector('.modal-body');
            
            let htmlContent = `
                <div class="evaluacion-summary">
                    <h3>${materia.nombre}</h3>
                    <div class="evaluacion-meta">
                        <span><i class="fas fa-code"></i> Código: ${materia.codigo}</span>
                        <span><i class="fas fa-layer-group"></i> Sección: ${materia.seccion}</span>
                    </div>
                    <div class="evaluacion-score-large">
                        <span class="score-label">Calificación Acumulada</span>
                        <span class="score-value" style="font-size: 1.5em;">${materia.promedioDisplay}</span>
                    </div>
                </div>
                
                <div class="evaluacion-criterios">
                    <h4><i class="fas fa-list-alt"></i> Evaluaciones (Rúbricas)</h4>
            `;
            
            if (materia.rubricas && materia.rubricas.length > 0) {
                materia.rubricas.forEach(rubrica => {
                    const puntaje = rubrica.puntaje_obtenido !== null ? parseFloat(rubrica.puntaje_obtenido).toFixed(2) : '-';
                    const maximo = parseFloat(rubrica.puntaje_maximo).toFixed(2);
                    const porcentaje = rubrica.porcentaje;
                    // Calculate progress width relative to max score if scored, else 0
                    const progressWidth = rubrica.puntaje_obtenido !== null ? (rubrica.puntaje_obtenido / rubrica.puntaje_maximo) * 100 : 0;
                    
                    htmlContent += `
                        <div class="criterio-evaluado">
                            <div class="criterio-eval-header">
                                <h5>${rubrica.nombre} <small>(${porcentaje}%)</small></h5>
                                <span class="criterio-score">${puntaje}/${maximo}</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressWidth}%"></div>
                            </div>
                            ${rubrica.observaciones ? `<p class="criterio-feedback"><strong>Observaciones:</strong> ${rubrica.observaciones}</p>` : ''}
                            ${rubrica.fecha ? `<p class="criterio-feedback"><small>Fecha: ${new Date(rubrica.fecha).toLocaleDateString()}</small></p>` : ''}
                        </div>
                    `;
                });
            } else {
                htmlContent += '<p>No hay evaluaciones registradas para esta materia.</p>';
            }
            
            htmlContent += `</div>`;
            
            // Replace content but keep the footer buttons (or recreate them)
            // Actually, let's just replace the body content
            // We need to preserve the footer if we want the buttons to work, but the "Descargar Reporte" might need logic too.
            // For now, let's just update the innerHTML of a container or the whole body.
            
            // Let's clear the existing static body content first
            const summaryDiv = modal.querySelector('.evaluacion-summary');
            const criteriosDiv = modal.querySelector('.evaluacion-criterios');
            const comentariosDiv = modal.querySelector('.comentarios-generales');
            
            if(summaryDiv) summaryDiv.remove();
            if(criteriosDiv) criteriosDiv.remove();
            if(comentariosDiv) comentariosDiv.remove();
            
            // Insert new content
            modalBody.innerHTML = htmlContent + modalBody.innerHTML; // Keep footer if it's inside body? No, footer is sibling.
            
            // Wait, the modal structure in the file is:
            // .modal-content > .modal-header, .modal-body, .modal-footer
            // So I should just set .modal-body.innerHTML
            
            modalBody.innerHTML = htmlContent;

            // Show modal
            modal.style.display = 'flex';
            
            // Close modal logic (already in home.js or inline?)
            // The close button has onclick="cerrarModal('evaluacionModal')"
            // We need to ensure closing works.
        }
        
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function descargarEvaluacion() {
            Swal.fire({
                icon: 'info',
                title: 'Descargar Reporte',
                text: 'Esta funcionalidad estará disponible pronto.'
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('evaluacionModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>
</body>
</html>
